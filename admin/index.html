<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šåº—å®¶å®¢æœå¾Œå°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; display: flex; height: 100vh; height: 100dvh; margin: 0; background: #f4f6f8; overflow: hidden; }
        
        #login-modal { position: fixed; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-card { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .login-card button { width: 100%; padding: 14px; background: #0084ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        
        #dashboard { display: none; width: 100%; height: 100%; overflow: hidden; position: relative; }
        
        #sidebar { width: 300px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; height: 100%; z-index: 2; }
        #shop-info-box { padding: 15px; background: #2c3e50; color: white; display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0; }
        #logout-btn { background: #c0392b; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        
        #user-list { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        
        .user-row { padding: 18px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .user-row:active { background: #f5f5f5; }
        .user-row.active { background: #e3f2fd; border-left: 4px solid #0084ff; }
        .unread-badge { background-color: #ff3b30; color: white; border-radius: 12px; padding: 3px 8px; font-size: 12px; font-weight: bold; display: none; }

        #chat-main { flex: 1; display: flex; flex-direction: column; background: white; height: 100%; position: relative; z-index: 1; }
        
        #chat-header { 
            padding: 0 15px; height: 50px; border-bottom: 1px solid #eee;
            font-weight: bold; color: #333; background: #fafafa;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }

        /* é ‚éƒ¨åŠŸèƒ½æŒ‰éˆ•å€ */
        .header-actions { display: flex; gap: 10px; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; border-radius: 4px; color: #555; }
        .icon-btn:hover { background: #eee; }

        #footprint-box {
            background: #fffbe6; border-bottom: 1px solid #ffe58f;
            padding: 8px 15px; font-size: 13px; color: #555;
            display: none; align-items: center; gap: 10px;
            flex-shrink: 0;
        }
        #footprint-img { width: 30px; height: 30px; border-radius: 4px; object-fit: cover; border: 1px solid #ddd; display: none; }
        #footprint-link { text-decoration: none; color: #0084ff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; display: inline-block;}
        #footprint-link:hover { text-decoration: underline; }

        #back-btn { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: #0084ff; padding-right: 10px; }

        #messages { flex: 1; padding: 15px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }
        
        .cb-msg-row { display: flex; flex-direction: column; max-width: 85%; }
        .cb-msg-row.user { align-self: flex-start; align-items: flex-start; }
        .cb-msg-row.admin { align-self: flex-end; align-items: flex-end; } 

        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.5; word-break: break-all; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble.admin { background: #0084ff; color: white; border-bottom-right-radius: 4px; }
        .bubble.user { background: #f1f1f1; color: #333; border-bottom-left-radius: 4px; }
        .bubble.image { background: transparent !important; padding: 0; box-shadow: none; }
        .cb-msg-img { max-width: 200px; border-radius: 12px; border: 1px solid #eee; cursor: zoom-in; }
        .cb-time { font-size: 11px; color: #aaa; }
        .read-status { font-size: 10px; color: #999; }
        .read-status.read { color: #0084ff; font-weight: bold; }
        .cb-details { display: flex; align-items: center; margin-top: 4px; gap: 8px; }
        .cb-msg-row.admin .cb-details { justify-content: flex-end; }
        .cb-msg-row.user .cb-details { justify-content: flex-start; }

        /* â˜…â˜…â˜… å•†å“å¡ç‰‡æ¨£å¼ (å¾Œå°é¡¯ç¤ºç”¨) â˜…â˜…â˜… */
        .bubble.product {
            padding: 0;
            background: white;
            border: 1px solid #ddd;
            overflow: hidden;
            width: 240px;
            border-radius: 12px;
        }
        .p-card-img { width: 100%; height: 210px; object-fit: cover; background: #f9f9f9; border-bottom: 1px solid #eee; }
        .p-card-body { padding: 10px; }
        .p-card-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color:#333; line-height: 1.4; }
        .p-card-price { color: #c62828; font-weight: bold; font-size: 16px; margin-bottom: 8px; }
        .p-card-btn { display: block; width: 100%; padding: 8px 0; background: #0084ff; color: white; text-align: center; text-decoration: none; border-radius: 4px; font-size: 14px; }
        .p-card-btn:hover { background: #006ec9; }

        #typing-status { height: 24px; padding: 0 15px; font-size: 12px; color: #888; display: flex; align-items: center; background: #fff; }
        
        #reply-box { padding: 10px 15px 15px 15px; border-top: 1px solid #eee; background: #fff; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        #reply-input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 24px; outline: none; font-size: 16px; background: #f9f9f9; -webkit-appearance: none; }
        #reply-input:focus { border-color: #0084ff; background: #fff; }
        #upload-btn { cursor: pointer; font-size: 26px; color: #0084ff; padding: 5px; display: flex; align-items: center; }
        #file-input { display: none; }
        #send-btn { width: 40px; height: 40px; cursor: pointer; margin-left: 2px; border-radius: 50%; transition: transform 0.1s; }
        #send-btn:active { transform: scale(0.9); background: #f0f0f0; }

        #image-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; backdrop-filter: blur(5px); animation: fadeIn 0.2s; }
        #modal-img { max-width: 95%; max-height: 95%; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); animation: zoomIn 0.2s; object-fit: contain; }
        #close-modal { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; font-weight: bold; cursor: pointer; z-index: 2001; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        @keyframes zoomIn { from {transform:scale(0.9);} to {transform:scale(1);} }
        
        .status-box { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; background: #fff; }
        .status-label { font-size: 14px; font-weight: bold; color: #555; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; } 
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* â˜…â˜…â˜… å³å´å®¢æˆ¶è³‡è¨Šå¡ (Profile Sidebar) â˜…â˜…â˜… */
        #profile-sidebar {
            width: 0; 
            background: white; 
            border-left: 1px solid #e0e0e0; 
            transition: width 0.3s ease; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            position: relative; /* ç‚ºäº†å®šä½è¿”å›æŒ‰éˆ• */
        }
        #profile-sidebar.open { width: 300px; }

        .profile-header { padding: 30px 20px 20px; text-align: center; border-bottom: 1px solid #eee; background: #fafafa; }
        .profile-avatar { width: 80px; height: 80px; background: #0084ff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 10px; font-weight: bold;}
        .profile-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .profile-id { font-size: 12px; color: #999; }

        .profile-body { padding: 20px; flex: 1; overflow-y: auto; }
        .data-row { margin-top:40px; margin-bottom: 20px; }
        .data-label { font-size: 12px; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; margin-top: 15px;}
        .data-value { font-size: 15px; color: #333; word-break: break-all; display: flex; align-items: center; gap: 8px;}
        
        .tag { display: inline-block; padding: 2px 8px; background: #e3f2fd; color: #0084ff; border-radius: 12px; font-size: 12px; font-weight: bold; margin-right: 5px; }
        .tag.vip { background: #fff8e1; color: #ff9800; border: 1px solid #ffe082; }
        .tag.risk { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }

        .stat-box { display: flex; justify-content: space-between; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stat-item { text-align: center; flex: 1; }
        .stat-num { font-size: 18px; font-weight: bold; color: #0084ff; display: block; }
        .stat-desc { font-size: 12px; color: #666; }

        #status-text { font-size: 12px; color: #888; margin-right: 10px; }
        
        /* â˜…â˜…â˜… æ–°å¢ï¼šæ‰‹æ©Ÿç‰ˆè³‡è¨Šå¡è¿”å›æŒ‰éˆ•æ¨£å¼ â˜…â˜…â˜… */
        #profile-back-btn { 
            display: none; 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            color: #0084ff; 
            z-index: 25; 
            padding: 5px;
        }

        @media (max-width: 768px) {
            /* éŸ¿æ‡‰å¼ï¼šæ‰‹æ©Ÿç‰ˆè¦†è“‹æ•´å€‹ç•«é¢ */
            #profile-sidebar.open { position: absolute; top: 0; right: 0; width: 100%; height: 100%; z-index: 20; }
            #close-profile-btn { display: block; position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; padding: 10px; }
            
            /* â˜… æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºè¿”å›æŒ‰éˆ• */
            #profile-back-btn { display: block; }

            #dashboard { display: block; }
            #sidebar { width: 100%; position: absolute; top: 0; left: 0; display: flex; }
            #chat-main { width: 100%; position: absolute; top: 0; left: 0; transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 10; }
            #dashboard.show-chat #chat-main { transform: translateX(0); }
            #dashboard.show-chat #sidebar { display: none; } 
            #back-btn { display: block; }
            #chat-header { padding-left: 5px; }
            .cb-msg-img { max-width: 60vw; }
            #footprint-link { max-width: 200px; }
        }
        #close-profile-btn { display: none; }

        /* â˜…â˜…â˜… å¸¸ç”¨å›å¾©æ¼¢å ¡é¸å–® (UIå„ªåŒ–ç‰ˆ) â˜…â˜…â˜… */
        #quick-reply-btn {
            font-size: 24px;
            cursor: pointer;
            color: #555;
            padding: 5px 10px;
            margin-right: 5px;
            background: none;
            border: none;
            transition: color 0.2s;
        }
        #quick-reply-btn:hover { color: #0084ff; }

        /* é¸å–®å®¹å™¨ (å‘ä¸Šå½ˆå‡º) */
        #quick-reply-menu {
            display: none;
            position: absolute;
            bottom: 70px; /* åœ¨è¼¸å…¥æ¡†ä¸Šæ–¹ */
            left: 15px;
            width: 280px; /* ç¨å¾®åŠ å¯¬ */
            max-height: 400px; /* é™åˆ¶é«˜åº¦ */
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid #eee;
            z-index: 100;
            overflow: hidden;
            animation: slideUp 0.2s ease-out;
            display: flex;
            flex-direction: column;
        }
        @keyframes slideUp { from {transform: translateY(10px); opacity:0;} to {transform: translateY(0); opacity:1;} }

        #qr-list {
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }

        /* â˜… æ°£æ³¡æ¨£å¼çš„å¸¸ç”¨èª */
        .qr-item {
            padding: 10px 14px;
            margin-bottom: 8px; /* é–“è· */
            background: #0084ff; /* èƒŒæ™¯ */
            color: #ffffff;     /* æ–‡å­— */
            border-radius: 16px; /* åœ“è§’æ°£æ³¡ */
            cursor: pointer;
            font-size: 14px;
            line-height: 1.4;
            transition: all 0.2s;
            word-break: break-word;
        }
        .qr-item:hover { 
            background: #bbdefb; /* hover è®Šæ·±ä¸€é» */
            transform: translateX(2px); /* å°å°ä½ç§» */
        }
        .qr-item:active {
            transform: scale(0.98);
        }
        .qr-item:last-child { margin-bottom: 0; }
        
        /* ç·¨è¼¯æŒ‰éˆ•åˆ— */
        .qr-footer {
            padding: 10px;
            background: #fafafa;
            border-top: 1px solid #eee;
            text-align: center;
        }
        .qr-edit-btn {
            font-size: 12px;
            color: #666;
            cursor: pointer;
            text-decoration: underline;
        }

        /* â˜…â˜…â˜… ç·¨è¼¯å¸¸ç”¨èªçš„ Modal â˜…â˜…â˜… */
        #qr-editor-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .qr-editor-card { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; max-height: 80vh; }
        .qr-list-container { flex: 1; overflow-y: auto; margin: 15px 0; border: 1px solid #eee; padding: 10px; border-radius: 4px; }
        .qr-edit-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .qr-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .qr-del-btn { background: #ff5252; color: white; border: none; padding: 0 10px; border-radius: 4px; cursor: pointer; }
        .qr-add-btn { background: #4caf50; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; margin-bottom: 10px; font-weight: bold;}
        .qr-save-btn { background: #0084ff; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 16px; }

        /* â˜…â˜…â˜… å•†å“ç·¨è¼¯å™¨ Modal æ¨£å¼ â˜…â˜…â˜… */
        #product-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .p-editor-card { background: white; width: 90%; max-width: 350px; padding: 20px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; }
        .p-input-group { display: flex; flex-direction: column; gap: 4px; }
        .p-input-group label { font-size: 12px; color: #666; font-weight: bold; }
        .p-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .p-preview-img { 
            width: 100%; /* height: 200px;  <-- ç§»é™¤åŸæœ¬çš„å›ºå®šé«˜åº¦ */
            aspect-ratio: 1 / 1; /* â˜…â˜…â˜… æ–°å¢ï¼šå¼·åˆ¶é•·å¯¬æ¯” 1:1 (æ­£æ–¹å½¢) â˜…â˜…â˜… */    
            object-fit: cover;   /* ç¢ºä¿åœ–ç‰‡å¡«æ»¿æ­£æ–¹å½¢ä¸”ä¸è®Šå½¢ */
            border-radius: 4px; 
            border: 1px solid #eee; 
            display: none; 
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-card">
            <h2 style="margin-top:0; color:#333;">å®¢æœå¾Œå°ç™»å…¥</h2>
            <input type="text" id="l_shop" placeholder="å•†åº— ID">
            <input type="password" id="l_pass" placeholder="ç®¡ç†å¯†ç¢¼">
            <button onclick="login()">ç™»å…¥ç³»çµ±</button>
            <p id="l_err" style="color:red; margin-top:10px; font-size:14px;"></p>
        </div>
    </div>

    <div id="image-modal" onclick="closeImageModal()">
        <span id="close-modal">&times;</span>
        <img id="modal-img">
    </div>

    <div id="dashboard">
        <div id="sidebar">
            <div id="shop-info-box">
                <span id="shop-name">è¼‰å…¥ä¸­...</span>
                <button id="logout-btn" onclick="logout()">ç™»å‡º</button>
            </div>
            
            <div class="status-box">
                <div class="status-label">å®¢æœç‹€æ…‹</div>
                <div style="display:flex; align-items:center;">
                    <span id="status-text">é›¢ç·š</span>
                    <label class="switch">
                        <input type="checkbox" id="online-toggle" onchange="toggleOnline()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div style="padding: 10px 15px; border-bottom: 1px solid #eee; background: #fafafa;">
                <input type="text" id="user-search" placeholder="ğŸ” æœå°‹å§“åã€ID æˆ–æ¨™ç±¤..." 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; outline:none; font-size:14px;"
                       onkeyup="filterUsers()">
                <div style="margin-top: 8px; display: flex; gap: 5px;">
                    <button onclick="filterByTag('VIP')" style="font-size:12px; padding:2px 10px; border:1px solid #ffe082; background:#fff8e1; color:#ff9800; border-radius:12px; cursor:pointer;">VIP</button>
                    <button onclick="filterByTag('é¢¨éšª')" style="font-size:12px; padding:2px 10px; border:1px solid #ffcdd2; background:#ffebee; color:#c62828; border-radius:12px; cursor:pointer;">é¢¨éšª</button>
                    <button onclick="filterByTag('')" style="font-size:12px; padding:2px 10px; border:1px solid #ddd; background:#fff; color:#666; border-radius:12px; cursor:pointer;">å…¨éƒ¨</button>
                </div>
            </div>

            <div id="user-list"></div>
        </div>

        <div id="chat-main">
            <div id="chat-header">
                <div style="display:flex; align-items:center;">
                    <button id="back-btn" onclick="backToList()">â®</button>
                    <span id="chat-title">è«‹é¸æ“‡ä½¿ç”¨è€…</span>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleProfile()" title="æŸ¥çœ‹å®¢æˆ¶è³‡æ–™">ğŸ‘¤</button>
                </div>
            </div>

            <div id="footprint-box">
                <span>æ­£åœ¨ç€è¦½ï¼š</span>
                <a id="footprint-link" href="#" target="_blank">é¦–é </a>
            </div>

            <div id="messages"></div>
            <div id="typing-status"></div>
            <div id="reply-box">
                <button id="quick-reply-btn" onclick="toggleQuickMenu()">â˜°</button>
                
                <button id="product-btn" onclick="openProductModal()" style="font-size: 24px; border: none; background: none; cursor: pointer; padding: 5px; margin-right:5px;">ğŸ›ï¸</button>

                <div id="quick-reply-menu">
                    <div id="qr-list">
                    </div>
                    <div class="qr-footer">
                        <span class="qr-edit-btn" onclick="openQrEditor()">âš™ï¸ ç·¨è¼¯å¸¸ç”¨èª</span>
                    </div>
                </div>

                <label for="file-input" id="upload-btn">ğŸ“·</label>
                <input type="file" id="file-input" accept="image/*">
                <input type="text" id="reply-input" placeholder="è¼¸å…¥è¨Šæ¯..." disabled>
                <img src="/icon/send.png" id="send-btn" alt="Send">
            </div>
        </div>

        <div id="profile-sidebar">
            <button id="profile-back-btn" onclick="toggleProfile()">â®</button>
            
            <div id="close-profile-btn" onclick="toggleProfile()">âœ•</div>
            
            <div class="profile-header">
                <div class="profile-avatar" id="p-avatar">?</div>
                <div class="profile-name" id="p-name">è¼‰å…¥ä¸­</div>
                <div class="profile-id" id="p-id">ID: ...</div>
            </div>

            <div class="profile-body">
                <div class="stat-box">
                    <div class="stat-item">
                        <span class="stat-num" id="p-spent">$0</span>
                        <span class="stat-desc">ç´¯ç©æ¶ˆè²»</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-num" id="p-orders">0</span>
                        <span class="stat-desc">è¨‚å–®æ•¸</span>
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-label">æ¨™ç±¤ (Tags)</div>
                    <div class="data-value" id="p-tags">
                        <span style="color:#999;font-style:italic;">ç„¡æ¨™ç±¤</span>
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-label">è¯çµ¡è³‡è¨Š</div>
                    <div class="data-value">ğŸ“§ <span id="p-email">--</span></div>
                    <div class="data-value" style="margin-top:5px;">ğŸ“± <span id="p-mobile">--</span></div>
                </div>

                <div class="data-row">
                    <div class="data-label">ç™»å…¥æ–¹å¼</div>
                    <div class="data-value" id="p-login">è¨ªå®¢</div>
                </div>
            </div>
        </div>
    </div>

    <div id="qr-editor-modal">
        <div class="qr-editor-card">
            <h3 style="margin:0 0 10px 0;">ç·¨è¼¯å¸¸ç”¨å›å¾©</h3>
            <button class="qr-add-btn" onclick="addQrRow()">+ æ–°å¢ä¸€å¥</button>
            <div class="qr-list-container" id="qr-edit-list">
                </div>
            <div style="display:flex; gap:10px;">
                <button style="flex:1; padding:12px; background:#ddd; border:none; border-radius:4px; cursor:pointer;" onclick="closeQrEditor()">å–æ¶ˆ</button>
                <button style="flex:1;" class="qr-save-btn" onclick="saveQrChanges()">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <div id="product-modal">
        <div class="p-editor-card">
            <h3 style="margin:0; text-align:center;">ç™¼é€å•†å“å¡ç‰‡</h3>
            
            <div class="p-input-group">
                <label>å•†å“ç¶²å€ (è²¼ä¸Šå¾ŒæŒ‰è‡ªå‹•æŠ“å–)</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="p-url" class="p-input" placeholder="https://..." onchange="autoScrape()">
                    <button onclick="autoScrape()" style="padding:0 10px; cursor:pointer;">ğŸ”</button>
                </div>
            </div>

            <img id="p-preview-img" class="p-preview-img">

            <div class="p-input-group">
                <label>åœ–ç‰‡ç¶²å€</label>
                <input type="text" id="p-img" class="p-input" placeholder="åœ–ç‰‡é€£çµ">
            </div>

            <div class="p-input-group">
                <label>å•†å“åç¨±</label>
                <input type="text" id="p-title" class="p-input" placeholder="è¼¸å…¥å•†å“åç¨±">
            </div>

            <div class="p-input-group">
                <label>åƒ¹æ ¼</label>
                <input type="text" id="p-price" class="p-input" placeholder="ä¾‹å¦‚ï¼š$500">
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button style="flex:1; padding:10px; border:none; background:#ddd; border-radius:4px; cursor:pointer;" onclick="closeProductModal()">å–æ¶ˆ</button>
                <button style="flex:1; padding:10px; border:none; background:#0084ff; color:white; border-radius:4px; cursor:pointer; font-weight:bold;" onclick="sendProductCard()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const SERVER = '/'; 
        let socket;
        let activeUser = null;
        let unreadCounts = {}; 
        let typingTimeout;    
        let userFootprints = {}; 

        let quickReplies = []; // å„²å­˜ç›®å‰çš„å¸¸ç”¨èªåˆ—è¡¨

        // â˜… å„²å­˜æ¯å€‹ä½¿ç”¨è€…çš„è©³ç´°è³‡æ–™
        let userProfiles = {}; 

        window.onload = function() {
            const savedShop = localStorage.getItem('admin_shop');
            const savedPass = localStorage.getItem('admin_pass');
            if(savedShop && savedPass) {
                document.getElementById('l_shop').value = savedShop;
                document.getElementById('l_pass').value = savedPass;
                login();
            }
        };

        // --- æ ¸å¿ƒé€£ç·šé‚è¼¯ (ä¿®æ­£ç‰ˆ) ---
        function login() {
            const shop = document.getElementById('l_shop').value.trim();
            const pass = document.getElementById('l_pass').value.trim();
            if(!shop || !pass) { alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"); return; }
            if(socket) socket.disconnect();

            // 1. åˆå§‹åŒ– Socket
            socket = io(SERVER, {
                auth: { shopId: shop, isAdmin: true },
                transports: ['websocket', 'polling']
            });

            // 2. ç¶å®šæ‰€æœ‰äº‹ä»¶ç›£è½å™¨ (å¿…é ˆåœ¨ socket åˆå§‹åŒ–ä¹‹å¾Œ)
            socket.on('connect', () => {
                socket.emit('adminLogin', { password: pass });
            });

            socket.on('loginSuccess', (data) => {
                localStorage.setItem('admin_shop', shop);
                localStorage.setItem('admin_pass', pass);
                document.getElementById('login-modal').style.display = 'none';
                const dash = document.getElementById('dashboard');
                dash.style.display = (window.innerWidth <= 768) ? 'block' : 'flex';
                document.getElementById('shop-name').innerText = data.shopName;
                
                // æ›´æ–°ç‹€æ…‹é–‹é—œ
                const toggle = document.getElementById('online-toggle');
                toggle.checked = data.isOnline;
                
                // â˜… æ–°å¢é€™è¡Œï¼š
                quickReplies = data.quickReplies || []; 
                updateStatusText(data.isOnline);
            });

            socket.on('loginError', (err) => {
                document.getElementById('l_err').innerText = err;
                localStorage.removeItem('admin_pass');
                socket.disconnect();
            });

            // admin/index.html å…§çš„ socket.on('initUserList')
            socket.on('initUserList', (data) => {
                const users = data.users || {}; 
                unreadCounts = data.unreadStats || {}; 
                
                // â˜…â˜…â˜… æ¥æ”¶ä¼ºæœå™¨å‚³ä¾†çš„æ‰€æœ‰ CRM è³‡æ–™ â˜…â˜…â˜…
                // é€™æ¨£å³ä½¿é¡§å®¢é›¢ç·šï¼Œè³‡æ–™ä¹Ÿæœƒå­˜åœ¨é€™è£¡
                if (data.userProfiles) {
                    userProfiles = data.userProfiles;
                }

                const list = document.getElementById('user-list');
                list.innerHTML = '';
                
                Object.keys(users).forEach(uid => renderUserInList(uid, users[uid]));
            });
            // â˜… æ–°å¢ï¼šæ¥æ”¶å¾Œç«¯å‚³ä¾†çš„ã€Œæ­¸é›¶ã€æŒ‡ä»¤
            socket.on('unreadCountReset', (data) => {
                if(unreadCounts[data.userId]) {
                    unreadCounts[data.userId] = 0;
                    // æ‰¾åˆ°è©²åˆ—ä¸¦éš±è—ç´…é»
                    const row = document.querySelector(`.user-row[data-id="${data.userId}"]`);
                    if(row) {
                        const badge = row.querySelector('.unread-badge');
                        if(badge) badge.style.display = 'none';
                    }
                }
            });

            // â˜…â˜…â˜… æ¥æ”¶ä½¿ç”¨è€… Profile æ›´æ–° â˜…â˜…â˜…
            socket.on('userProfileUpdate', (data) => {
                userProfiles[data.userId] = data; // å­˜èµ·ä¾†
                if (activeUser === data.userId) {
                    renderProfile(data.userId); // å¦‚æœæ­£åœ¨çœ‹ä»–ï¼Œé¦¬ä¸Šæ›´æ–°ä»‹é¢
                }
            });

            // è¶³è·¡æ›´æ–°
            socket.on('userPageUpdate', (data) => {
                userFootprints[data.userId] = data;
                if (activeUser === data.userId) {
                    renderFootprint(data);
                }
            });

            // å®¢æœç‹€æ…‹æ›´æ–° (åŒæ­¥ç”¨)
            socket.on('shopStatusUpdate', (data) => {
                const toggle = document.getElementById('online-toggle');
                toggle.checked = data.isOnline;
                updateStatusText(data.isOnline);
            });

            socket.on('updateUserList', (msg) => {
                const userId = msg.userId;
                let userRow = document.querySelector(`.user-row[data-id="${userId}"]`);
                
                if (!userRow) {
                    renderUserInList(userId, msg.userName);
                    userRow = document.querySelector(`.user-row[data-id="${userId}"]`);
                } else {
                    const list = document.getElementById('user-list');
                    list.prepend(userRow); // æŠŠæœ‰æ–°è¨Šæ¯çš„äººç§»åˆ°æœ€ä¸Šé¢
                }

                // å¦‚æœç¾åœ¨ä¸æ˜¯æ­£åœ¨è·Ÿé€™å€‹äººèŠå¤©ï¼Œä¸”è¨Šæ¯æ˜¯ user ç™¼çš„
                if (activeUser !== userId && msg.sender !== 'admin') {
                    if (!unreadCounts[userId]) unreadCounts[userId] = 0;
                    unreadCounts[userId]++; // ç´¯åŠ 
                    
                    const badge = userRow.querySelector('.unread-badge');
                    badge.innerText = unreadCounts[userId] > 99 ? '99+' : unreadCounts[userId];
                    badge.style.display = 'inline-block';
                }
            });

            socket.on('newMessage', (msg) => {
                if (activeUser === msg.userId) {
                    renderMsg(msg);
                    updateTypingStatus(false);

                    // â˜…â˜…â˜… æ–°å¢é€™ä¸€æ®µï¼šå¦‚æœæˆ‘æ­£åœ¨è·Ÿé€™å€‹äººèŠå¤©ï¼Œæ”¶åˆ°æ–°è¨Šæ¯å°±é¦¬ä¸Šæ¨™è¨˜å·²è®€ â˜…â˜…â˜…
                    if (msg.sender === 'user') {
                        socket.emit('markMessagesRead', { targetUserId: activeUser, reader: 'admin' });
                    }
                }
            });

            socket.on('history', (msgs) => {
                const box = document.getElementById('messages');
                box.innerHTML = ''; 
                msgs.forEach(msg => renderMsg(msg));
                updateTypingStatus(false);
            });

            socket.on('displayTyping', (data) => {
                if (activeUser && data.userId === activeUser) {
                    updateTypingStatus(data.isTyping);
                }
            });

            socket.on('quickRepliesUpdated', (replies) => {
                quickReplies = replies;
                renderQuickMenu(); // æ›´æ–°é¸å–®ç•«é¢
                closeQrEditor();   // é—œé–‰ç·¨è¼¯è¦–çª—
                // alert('å¸¸ç”¨èªå·²æ›´æ–°ï¼');
            });

            // â˜…â˜…â˜… è£œä¸Šç¼ºå°‘çš„ç›£è½å™¨ï¼šå•†å“æŠ“å–æˆåŠŸ â˜…â˜…â˜…
            socket.on('productScraped', (data) => {
                document.getElementById('p-title').value = data.title;
                document.getElementById('p-img').value = data.image;
                document.getElementById('p-price').value = data.price;
                
                if(data.image) {
                    const img = document.getElementById('p-preview-img');
                    img.src = data.image;
                    img.style.display = 'block';
                }
                // æ¢å¾© placeholder
                document.getElementById('p-title').placeholder = "è¼¸å…¥å•†å“åç¨±";
            });

            // â˜…â˜…â˜… è£œä¸Šç¼ºå°‘çš„ç›£è½å™¨ï¼šæŠ“å–å¤±æ•— â˜…â˜…â˜…
            socket.on('scrapeError', (msg) => {
                alert(msg);
                document.getElementById('p-title').placeholder = "è«‹æ‰‹å‹•è¼¸å…¥";
            });

            // â˜…â˜…â˜… ä¿®å¾©ï¼šç•¶æ”¶åˆ°ã€Œå°æ–¹å·²è®€ã€çš„é€šçŸ¥æ™‚ï¼Œæ›´æ–°ä»‹é¢ â˜…â˜…â˜…
            socket.on('messagesWereRead', (data) => {
                // å¦‚æœæ˜¯å®¢äºº (user) è®€äº†è¨Šæ¯ï¼Œä¸”æˆ‘æ­£åœ¨è·Ÿé€™å€‹äººèŠå¤© (activeUser)
                if (data.reader === 'user' && activeUser) {
                    
                    // 1. æŠ“å‡ºæ‰€æœ‰ç‹€æ…‹æ˜¯ "å·²å‚³é€" çš„æ¨™ç±¤
                    // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘ç”¨å¯¬é¬†çš„é¸å–æ–¹å¼ï¼ŒæŠ“æ‰€æœ‰ read-status
                    const statuses = document.querySelectorAll('.read-status');
                    
                    statuses.forEach(el => {
                        // 2. åªè¦ä¸æ˜¯å·²è®€ï¼Œå°±é€šé€šæ”¹æˆå·²è®€
                        if (el.innerText !== 'å·²è®€') {
                            el.innerText = 'å·²è®€';
                            el.classList.add('read'); // è®Šè—è‰²
                            el.style.color = '#0084ff';
                            el.style.fontWeight = 'bold';
                        }
                    });
                }
            });
        }

        // --- è¼”åŠ©å‡½å¼ ---

        // â˜…â˜…â˜… æ¸²æŸ“è³‡è¨Šå¡é‚è¼¯ (V26.0 - ç©©å®šç‰ˆ) â˜…â˜…â˜…
        function renderProfile(userId) {
            const data = userProfiles[userId] || {};
            const name = document.getElementById('chat-title').innerText; 

            // 1. åŸºæœ¬é ­åƒèˆ‡åç¨±
            document.getElementById('p-avatar').innerText = (data.userName || name || "?")[0].toUpperCase();
            document.getElementById('p-name').innerText = data.userName || name;
            
            let statusDot = data.accountStatus === 'enabled' ? 'ğŸŸ¢' : 'ğŸ”´';
            document.getElementById('p-id').innerText = `${statusDot} ID: ${userId}`;
            
            // 2. â˜…â˜…â˜… è³¼ç‰©è»Šå€å¡Š (ç°¡åŒ–ç‰ˆï¼šåªé¡¯ç¤ºç¸½é‡‘é¡) â˜…â˜…â˜…
            let cartHtml = '';
            const cartTotal = parseInt(data.cartTotal || 0);
            
            if (cartTotal > 0) {
                // å› ç‚ºæˆ‘å€‘ç‚ºäº†ç©©å®šæ€§æš«æ™‚ç§»é™¤äº†è©³ç´°æ¸…å–®ï¼Œæ‰€ä»¥é€™è£¡åªé¡¯ç¤ºç¸½è¦½
                cartHtml = `
                    <div class="cart-section">
                        <div class="cart-header-bar" style="border-bottom:none; border-radius:8px;">
                            <span>ğŸ›’ è³¼ç‰©è»Šæœªçµå¸³ (${data.cartCount || 0} ä»¶)</span>
                            <span>$${cartTotal.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            } else {
                cartHtml = `<div style="padding:10px; text-align:center; color:#ccc; font-size:12px; border:1px dashed #eee; border-radius:8px; margin-bottom:15px;">ğŸ›’ è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>`;
            }

            // 3. é¢¨éšªè­¦ç¤ºå€å¡Š
            const riskScore = parseInt(data.riskScore || 0);
            let alertHtml = '';
            if (riskScore > 0) {
                alertHtml = `
                    <div style="background:#ffebee; color:#c62828; padding:10px; border-radius:8px; margin-bottom:15px; font-weight:bold; display:flex; align-items:center; gap:5px; border:1px solid #ffcdd2;">
                        âš ï¸ è­¦å‘Šï¼šåµæ¸¬åˆ° ${riskScore} æ¬¡æœªå–è²¨
                    </div>
                `;
            }

            // â˜…â˜…â˜… æº–å‚™å¾Œå°é€£çµ (å‹•æ…‹ç¶²åŸŸç‰ˆ) â˜…â˜…â˜…
            let backendUrl = "javascript:void(0);"; 
            let linkStyle = "color:#999; cursor:default; text-decoration:none;"; 
            let linkTitle = "ç„¡å¾Œå°é€£çµ";

            // ğŸŸ¢ åˆ¤æ–· 1: Cyberbiz (å‰ç¶´ cb_)
            if (userId.startsWith('cb_')) {
                const rawId = userId.replace(/^cb_/, '');
                
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨å‚³éä¾†çš„ shopDomainï¼Œå¦‚æœæ²’æœ‰å‰‡ç”¨é è¨­å€¼ â˜…â˜…â˜…
                // é€™æ¨£ä¸ç®¡æ˜¯å“ªä¸€å®¶åº—ï¼Œéƒ½æœƒé€£åˆ°ä»–è‡ªå®¶çš„ Cyberbiz å¾Œå°
                const domain = data.shopDomain || "geniusart.cyberbiz.co"; 
                
                backendUrl = `https://${domain}/admin/members/${rawId}?tab=orders`;
                linkStyle = "color:#0084ff; text-decoration:underline; cursor:pointer;";
                linkTitle = `å‰å¾€ ${domain} å¾Œå°`;
            }
            // ğŸŸ¡ Shopline / Shopify æœªä¾†ä¹Ÿå¯ä»¥ç”¨åŒæ¨£é‚è¼¯æ“´å……
            else if (userId.startsWith('sl_')) {
                const rawId = userId.replace(/^sl_/, '');
                // å‡è¨­ Shopline ç¶²å€æ ¼å¼ (éœ€ç¢ºèª)
                backendUrl = `https://admin.shoplineapp.com/customers/${rawId}`; 
                linkStyle = "color:#00b900; text-decoration:underline; cursor:pointer;";
                linkTitle = "å‰å¾€ Shopline å¾Œå°";
            }
            // ğŸŸ  åˆ¤æ–· 3: Shopify (å‰ç¶´ sp_) -> æœªä¾†æ“´å……ç”¨
            else if (userId.startsWith('sp_')) {
                const rawId = userId.replace(/^sp_/, '');
                // å‡è¨­ Shopify ç¶²å€æ ¼å¼
                backendUrl = `https://admin.shopify.com/store/my-store/customers/${rawId}`;
                linkStyle = "color:#95bf47; text-decoration:underline; cursor:pointer;";
                linkTitle = "å‰å¾€ Shopify å¾Œå°";
            }

            // â˜…â˜…â˜… æ–°å¢ï¼šå…§éƒ¨å‚™è¨»å€å¡Š HTML â˜…â˜…â˜…
            const noteHtml = `
                <div class="data-row" style="flex-direction:column; align-items:flex-start; background:#fff8e1; border:1px solid #ffe082; padding:10px; border-radius:8px; margin-bottom:15px;">
                    <div class="data-label" style="margin-bottom:5px; color:#f57f17; font-weight:bold;">ğŸŸ¡ å…§éƒ¨å‚™è¨» (åƒ…å®¢æœå¯è¦‹)</div>
                    <textarea id="note-input-${userId}" 
                        style="width:100%; height:60px; border:1px solid #ddd; border-radius:4px; padding:5px; resize:none; font-size:13px; font-family:sans-serif;" 
                        placeholder="åœ¨æ­¤è¼¸å…¥å®¢æˆ¶ç‰¹å¾µã€å¾…è¾¦äº‹é …..."
                    >${data.internalNote || ''}</textarea>
                    <div style="width:100%; text-align:right; margin-top:5px;">
                        <button onclick="saveInternalNote('${userId}')" 
                            style="padding:4px 12px; background:#ffb300; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px; font-weight:bold;">
                            ğŸ’¾ å„²å­˜å‚™è¨»
                        </button>
                    </div>
                </div>
            `;

            // 4. â˜…â˜…â˜… è¯çµ¡è³‡è¨Š (æ–°å¢åœ°å€é¡¯ç¤º) â˜…â˜…â˜…
            const infoHtml = noteHtml + `
                <div class="data-row">
                    <div class="data-label">è¯çµ¡è³‡è¨Š</div>
                    <div class="data-value">ğŸ“§ ${data.email || "--"}</div>
                    <div class="data-value" style="margin-top:5px;">ğŸ“± ${data.mobile || "--"}</div>
                    <div class="data-value" style="margin-top:5px; line-height:1.4;">ğŸ“ ${data.address || "--"}</div>
                </div>
                
                <div class="stat-box">
                    <div class="stat-item">
                        <span class="stat-num">$${parseFloat(data.totalSpent || 0).toLocaleString()}</span>
                        <span class="stat-desc">ç´¯ç©æ¶ˆè²»</span>
                    </div>
                    
                    <div class="stat-item">
                        <a href="${backendUrl}" target="_blank" style="text-decoration:none;" title="${linkTitle}">
                            <span class="stat-num" style="${linkStyle}">
                                ${data.ordersCount || 0}
                            </span>
                        </a>
                        <span class="stat-desc">è¨‚å–®æ•¸ ğŸ”—</span>
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-label">æ¨™ç±¤ (Tags)</div>
                    <div class="data-value" id="p-tags-container"></div>
                </div>
            `;

            // 5. çµ„åˆ HTML
            const body = document.querySelector('.profile-body');
            body.innerHTML = alertHtml + cartHtml + infoHtml;

            // 6. è™•ç†æ¨™ç±¤
            const tagsContainer = document.getElementById('p-tags-container');
            if (data.tags && data.tags.trim() !== '') {
                data.tags.split(',').forEach(tag => {
                    const span = document.createElement('span');
                    span.className = 'tag';
                    if(tag.includes('VIP') || tag.includes('é»‘åå–®')) span.className += ' vip'; 
                    if(tag.includes('é»‘åå–®') || tag.includes('æœªå–è²¨') || tag.includes('é¢¨éšª')) span.className += ' risk';
                    span.innerText = tag;
                    tagsContainer.appendChild(span);
                });
            } else {
                tagsContainer.innerHTML = '<span style="color:#999;font-style:italic;">ç„¡æ¨™ç±¤</span>';
            }
        }

        function toggleProfile() {
            const sidebar = document.getElementById('profile-sidebar');
            sidebar.classList.toggle('open');
        }

        // åˆ‡æ›ä½¿ç”¨è€…æ™‚
        function selectUser(uid, name) {
            activeUser = uid;
            
            // â˜…â˜…â˜… æ–°å¢ï¼šå‘Šè¨´ Server æˆ‘è®€äº†é€™å€‹äººçš„è¨Šæ¯
            if(socket) {
                socket.emit('markMessagesRead', { targetUserId: uid, reader: 'admin' });
            }
            
            document.querySelectorAll('.user-row').forEach(e => e.classList.remove('active'));
            document.querySelector(`.user-row[data-id="${uid}"]`).classList.add('active');
            
            unreadCounts[uid] = 0; 
            const badge = document.querySelector(`.user-row[data-id="${uid}"] .unread-badge`);
            if (badge) badge.style.display = 'none';
            
            document.getElementById('chat-title').innerText = name;
            document.getElementById('reply-input').disabled = false;
            document.getElementById('messages').innerHTML = '<div style="text-align:center;color:#999;margin-top:20px;">è¼‰å…¥ä¸­...</div>';
            updateTypingStatus(false); 
            showChat();
            renderFootprint(userFootprints[uid]);
            renderProfile(uid);
            socket.emit('adminJoinUser', { userId: uid });
        }

        function toggleOnline() {
            // é˜²å‘†ï¼šç¢ºä¿ socket å­˜åœ¨
            if (!socket) return; 
            const toggle = document.getElementById('online-toggle');
            const isOnline = toggle.checked;
            socket.emit('adminToggleStatus', { isOnline: isOnline });
            updateStatusText(isOnline);
        }

        function updateStatusText(isOnline) {
            const text = document.getElementById('status-text');
            text.innerText = isOnline ? "ç·šä¸Šå¾…å‘½" : "æš«æ™‚é›¢é–‹";
            text.style.color = isOnline ? "#2ecc71" : "#aaa";
        }

        function backToList() {
            document.getElementById('dashboard').classList.remove('show-chat');
            document.activeElement.blur(); 
            activeUser = null;
        }

        function showChat() {
            document.getElementById('dashboard').classList.add('show-chat');
        }

        function showImage(src) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-img');
            modal.style.display = "flex";
            modalImg.src = src;
        }

        function closeImageModal() {
            document.getElementById('image-modal').style.display = "none";
        }

        function updateTypingStatus(isTyping) {
            const statusDiv = document.getElementById('typing-status');
            if(isTyping) {
                statusDiv.innerHTML = `<span>å°æ–¹æ­£åœ¨è¼¸å…¥</span><span class="typing-dots"></span>`;
            } else {
                statusDiv.innerHTML = '';
            }
        }

        function logout() {
            localStorage.removeItem('admin_shop');
            localStorage.removeItem('admin_pass');
            location.reload();
        }

        function renderFootprint(data) {
            const box = document.getElementById('footprint-box');
            const link = document.getElementById('footprint-link');

            if (!data) {
                box.style.display = 'none'; 
                return;
            }

            box.style.display = 'flex';
            link.href = data.url;
            link.innerText = data.title || data.url;
        }

        function renderUserInList(uid, name) {
            const div = document.createElement('div');
            div.className = 'user-row';
            div.setAttribute('data-id', uid);
            
            // â˜… æª¢æŸ¥é€™å€‹äººæœ‰æ²’æœ‰æœªè®€ (å¾å…¨åŸŸè®Šæ•¸ unreadCounts æ‹¿)
            const count = unreadCounts[uid] || 0;
            const badgeDisplay = count > 0 ? 'inline-block' : 'none';
            const badgeText = count > 99 ? '99+' : count;

            div.innerHTML = `
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:500; font-size:16px;">${name}</span>
                    <span style="font-size:12px;color:#999; margin-top:4px;">${uid}</span>
                </div>
                <span class="unread-badge" style="display:${badgeDisplay}">${badgeText}</span>
            `;
            
            div.onclick = () => selectUser(uid, name);
            
            const list = document.getElementById('user-list');
            // ç‚ºäº†è®“æœ‰æœªè®€çš„äººæ’åœ¨ä¸Šé¢ï¼Œå¯ä»¥ç”¨ prepend
            // ä½†å¦‚æœæ‚¨å¸Œæœ›ç…§æ™‚é–“æ’ï¼Œé€™è£¡å¯èƒ½è¦èª¿æ•´ï¼Œç›®å‰ç¶­æŒ prepend (æœ€æ–°çš„äººåœ¨æœ€ä¸Š)
            list.prepend(div); 
        }

        // â˜…â˜…â˜… æ›´æ–° renderMsg: æ”¯æ´å•†å“å¡ç‰‡ (msgType='product') â˜…â˜…â˜…
        function renderMsg(msg) {
            const box = document.getElementById('messages');
            var date = new Date(msg.timestamp);
            var timeStr = date.getHours().toString().padStart(2, '0') + ":" + date.getMinutes().toString().padStart(2, '0');
            
            // â˜… åˆ¤æ–·å·²è®€ç‹€æ…‹ (å¦‚æœæ˜¯è‡ªå·±ç™¼çš„è¨Šæ¯ï¼Œæ‰é¡¯ç¤ºå·²è®€)
            let readHtml = '';
            if (msg.sender === 'admin') {
                const readText = msg.isRead ? 'å·²è®€' : 'å·²å‚³é€';
                const readClass = msg.isRead ? 'read' : '';
                readHtml = `<div class="read-status ${readClass}">${readText}</div>`;
            }

            const row = document.createElement('div');
            row.className = `cb-msg-row ${msg.sender}`;
            
            let contentHtml = '';

            // åˆ¤æ–·è¨Šæ¯é¡å‹
            if (msg.msgType === 'image') {
                contentHtml = `<div class="bubble image ${msg.sender}"><img src="${msg.text}" class="cb-msg-img" onclick="showImage(this.src)"></div>`;
            } 
            else if (msg.msgType === 'product') {
                // â˜… è§£æ JSON è³‡æ–™
                let p = {};
                try { p = JSON.parse(msg.text); } catch(e){}
                
                contentHtml = `
                    <div class="bubble product">
                        <img src="${p.image || '/icon/no-image.png'}" class="p-card-img">
                        <div class="p-card-body">
                            <div class="p-card-title">${p.title}</div>
                            <div class="p-card-price">${p.price}</div>
                            <a href="${p.url}" target="_blank" class="p-card-btn">æŸ¥çœ‹å•†å“</a>
                        </div>
                    </div>
                `;
            }
            else {
                contentHtml = `<div class="bubble ${msg.sender}">${msg.text}</div>`;
            }

            const detailsHtml = `
                <div class="cb-details">
                    ${readHtml}
                    <div class="cb-time">${timeStr}</div>
                </div>
            `;

            row.innerHTML = `${contentHtml}${detailsHtml}`;
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        const input = document.getElementById('reply-input');
        function sendTextMsg() {
            // é˜²å‘†ï¼šç¢ºä¿ socket å­˜åœ¨ä¸” activeUser å­˜åœ¨
            if (socket && activeUser && input.value.trim() !== '') {
                socket.emit('adminSendMessage', { targetUserId: activeUser, text: input.value, msgType: 'text' });
                socket.emit('adminTyping', { targetUserId: activeUser, isTyping: false });
                input.value = '';
            }
        }
        input.addEventListener('input', () => {
            if(activeUser && socket) {
                socket.emit('adminTyping', { targetUserId: activeUser, isTyping: true });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    socket.emit('adminTyping', { targetUserId: activeUser, isTyping: false });
                }, 2000);
            }
        });
        input.onkeypress = (e) => { if (e.key === 'Enter') sendTextMsg(); };
        document.getElementById('send-btn').onclick = sendTextMsg;

        const fileInput = document.getElementById('file-input');
        fileInput.onchange = async function() {
            if(!activeUser) { alert("è«‹å…ˆé¸æ“‡ä½¿ç”¨è€…"); fileInput.value = ''; return; }
            if(!socket) { alert("å°šæœªé€£ç·š"); return; }
            const file = fileInput.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('image', file);
            try {
                input.placeholder = "ä¸Šå‚³ä¸­...";
                input.disabled = true;
                const res = await fetch(SERVER + 'upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.url) {
                    socket.emit('adminSendMessage', { targetUserId: activeUser, text: data.url, msgType: 'image' });
                }
            } catch (err) { alert("ä¸Šå‚³å¤±æ•—"); } 
            finally { input.placeholder = "è¼¸å…¥è¨Šæ¯..."; input.disabled = false; fileInput.value = ''; }
        };

        // --- UI æ“ä½œå‡½å¼ ---

        function toggleQuickMenu() {
            const menu = document.getElementById('quick-reply-menu');
            if (menu.style.display === 'flex') {
                menu.style.display = 'none';
            } else {
                renderQuickMenu(); // æ¯æ¬¡æ‰“é–‹éƒ½é‡ç¹ª
                menu.style.display = 'flex'; // ç”¨ flex è®“å®ƒç›´å‘æ’åˆ—
            }
        }

        // â˜…â˜…â˜… ä¿®æ”¹ï¼šé»æ“Šå¾Œç›´æ¥ç™¼é€ (One-click Send) â˜…â˜…â˜…
        function useQuickReply(text) {
            // é˜²å‘†
            if (socket && activeUser) {
                socket.emit('adminSendMessage', { targetUserId: activeUser, text: text, msgType: 'text' });
                // é—œé–‰é¸å–®
                document.getElementById('quick-reply-menu').style.display = 'none';
            } else {
                alert("è«‹å…ˆé¸æ“‡ä½¿ç”¨è€…");
            }
        }

        // æ¸²æŸ“é¸å–® (èŠå¤©å®¤çš„å°é¸å–®)
        function renderQuickMenu() {
            const list = document.getElementById('qr-list');
            list.innerHTML = '';
            if (quickReplies.length === 0) {
                list.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">(å°šç„¡å¸¸ç”¨èª)</div>';
                return;
            }
            quickReplies.forEach(text => {
                const div = document.createElement('div');
                div.className = 'qr-item';
                div.innerText = text;
                div.onclick = () => useQuickReply(text); // ç¶å®šä¸€éµç™¼é€
                list.appendChild(div);
            });
        }

        // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('quick-reply-menu');
            const btn = document.getElementById('quick-reply-btn');
            // å¦‚æœé»æ“Šçš„ä¸æ˜¯æŒ‰éˆ•ä¹Ÿä¸æ˜¯é¸å–®æœ¬èº«ï¼Œå°±é—œé–‰
            if (menu && btn && !btn.contains(event.target) && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        // --- ç·¨è¼¯å™¨é‚è¼¯ ---

        function openQrEditor() {
            document.getElementById('quick-reply-menu').style.display = 'none'; // é—œé–‰å°é¸å–®
            document.getElementById('qr-editor-modal').style.display = 'flex';  // æ‰“é–‹å¤§ç·¨è¼¯å™¨
            
            const container = document.getElementById('qr-edit-list');
            container.innerHTML = '';
            quickReplies.forEach(text => {
                addQrRow(text);
            });
        }

        function closeQrEditor() {
            document.getElementById('qr-editor-modal').style.display = 'none';
        }

        function addQrRow(value = '') {
            const container = document.getElementById('qr-edit-list');
            const row = document.createElement('div');
            row.className = 'qr-edit-row';
            const escapedValue = value.replace(/"/g, '&quot;');
            row.innerHTML = `
                <input type="text" class="qr-input" value="${escapedValue}" placeholder="è¼¸å…¥å¸¸ç”¨å›å¾©å…§å®¹...">
                <button class="qr-del-btn" onclick="this.parentElement.remove()">âœ•</button>
            `;
            container.appendChild(row);
        }

        function saveQrChanges() {
            // è’é›†æ‰€æœ‰è¼¸å…¥æ¡†çš„å…§å®¹
            const inputs = document.querySelectorAll('.qr-edit-row .qr-input');
            const newReplies = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(text => text !== '');

            // ç™¼é€çµ¦ Server å„²å­˜
            socket.emit('adminUpdateQuickReplies', newReplies);
        }

        // --- å•†å“å¡ç‰‡é‚è¼¯ ---

        function openProductModal() {
            if(!activeUser) { alert("è«‹å…ˆé¸æ“‡ä½¿ç”¨è€…"); return; }
            document.getElementById('product-modal').style.display = 'flex';
            // æ¸…ç©ºæ¬„ä½
            document.getElementById('p-url').value = '';
            document.getElementById('p-img').value = '';
            document.getElementById('p-title').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('p-preview-img').style.display = 'none';
        }

        function closeProductModal() {
            document.getElementById('product-modal').style.display = 'none';
        }

        // è‡ªå‹•æŠ“å–
        function autoScrape() {
            const url = document.getElementById('p-url').value.trim();
            if(!url) return;
            // é¡¯ç¤º Loading
            document.getElementById('p-title').placeholder = "æŠ“å–ä¸­...";
            socket.emit('adminScrapeProduct', url);
        }

        // ç¢ºèªç™¼é€
        function sendProductCard() {
            const url = document.getElementById('p-url').value;
            const image = document.getElementById('p-img').value;
            const title = document.getElementById('p-title').value;
            const price = document.getElementById('p-price').value;

            if(!title || !url) { alert("è«‹è‡³å°‘è¼¸å…¥ç¶²å€å’Œæ¨™é¡Œ"); return; }

            socket.emit('adminSendProduct', {
                targetUserId: activeUser,
                url, image, title, price
            });
            
            closeProductModal();
        }

        // â˜…â˜…â˜… ä½¿ç”¨è€…æœå°‹èˆ‡ç¯©é¸é‚è¼¯ â˜…â˜…â˜…
        function filterUsers() {
            const input = document.getElementById('user-search');
            const filter = input.value.toLowerCase();
            const list = document.getElementById('user-list');
            const rows = list.getElementsByClassName('user-row');

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const uid = row.getAttribute('data-id');
                const name = row.innerText.toLowerCase(); // æŠ“å–é¡¯ç¤ºåœ¨åˆ—è¡¨ä¸Šçš„åå­—å’ŒID
                
                // é€²éšï¼šå¾ userProfiles å…¨åŸŸè®Šæ•¸æŠ“å–æ¨™ç±¤è³‡æ–™
                const profile = userProfiles[uid] || {};
                const tags = (profile.tags || "").toLowerCase();

                // æœå°‹ç¯„åœï¼šåå­—ã€IDã€æ¨™ç±¤
                if (name.includes(filter) || tags.includes(filter) || uid.includes(filter)) {
                    row.style.display = ""; // é¡¯ç¤º
                } else {
                    row.style.display = "none"; // éš±è—
                }
            }
        }

        function filterByTag(tagName) {
            const input = document.getElementById('user-search');
            input.value = tagName;
            filterUsers(); // è§¸ç™¼æœå°‹
        }

        // â˜…â˜…â˜… å„²å­˜å…§éƒ¨å‚™è¨» â˜…â˜…â˜…
        function saveInternalNote(uid) {
            const input = document.getElementById(`note-input-${uid}`);
            if (!input) return;

            const noteContent = input.value;
            
            // 1. ç™¼é€çµ¦ Server
            if (socket) {
                socket.emit('adminSaveNote', {
                    userId: uid,
                    note: noteContent
                });
            }

            // 2. æ›´æ–°æœ¬åœ°ç·©å­˜ (é€™æ¨£åˆ‡æ›å›ä¾†æ‰ä¸æœƒä¸è¦‹)
            if (userProfiles[uid]) {
                userProfiles[uid].internalNote = noteContent;
            }

            // 3. æŒ‰éˆ•å›é¥‹ (è¦–è¦ºæ•ˆæœ)
            const btn = input.nextElementSibling.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "âœ… å·²å„²å­˜";
            btn.style.background = "#4caf50";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = "#ffb300";
            }, 1000);
        }
    </script>
</body>
</html>