<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â§öÂ∫óÂÆ∂ÂÆ¢ÊúçÂæåÂè∞</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; display: flex; height: 100vh; height: 100dvh; margin: 0; background: #f4f6f8; overflow: hidden; }
        
        #login-modal { position: fixed; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-card { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .login-card input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .login-card button { width: 100%; padding: 14px; background: #0084ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        
        #dashboard { display: none; width: 100%; height: 100%; overflow: hidden; position: relative; }
        
        #sidebar { width: 300px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; height: 100%; z-index: 2; }
        #shop-info-box { padding: 15px; background: #2c3e50; color: white; display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0; }
        #logout-btn { background: #c0392b; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        
        #user-list { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        
        .user-row { padding: 18px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .user-row:active { background: #f5f5f5; }
        .user-row.active { background: #e3f2fd; border-left: 4px solid #0084ff; }
        .unread-badge { background-color: #ff3b30; color: white; border-radius: 12px; padding: 3px 8px; font-size: 12px; font-weight: bold; display: none; }

        #chat-main { flex: 1; display: flex; flex-direction: column; background: white; height: 100%; position: relative; z-index: 1; }
        
        #chat-header { 
            padding: 0 15px; height: 50px; border-bottom: 1px solid #eee;
            font-weight: bold; color: #333; background: #fafafa;
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }

        /* È†ÇÈÉ®ÂäüËÉΩÊåâÈàïÂçÄ */
        .header-actions { display: flex; gap: 10px; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; border-radius: 4px; color: #555; }
        .icon-btn:hover { background: #eee; }

        #footprint-box {
            background: #fffbe6; border-bottom: 1px solid #ffe58f;
            padding: 8px 15px; font-size: 13px; color: #555;
            display: none; align-items: center; gap: 10px;
            flex-shrink: 0;
        }
        #footprint-img { width: 30px; height: 30px; border-radius: 4px; object-fit: cover; border: 1px solid #ddd; display: none; }
        #footprint-link { text-decoration: none; color: #0084ff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; display: inline-block;}
        #footprint-link:hover { text-decoration: underline; }

        #back-btn { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: #0084ff; padding-right: 10px; }

        #messages { flex: 1; padding: 15px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }
        
        .cb-msg-row { display: flex; flex-direction: column; max-width: 85%; }
        .cb-msg-row.user { align-self: flex-start; align-items: flex-start; }
        .cb-msg-row.admin { align-self: flex-end; align-items: flex-end; } 

        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.5; word-break: break-all; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble.admin { background: #0084ff; color: white; border-bottom-right-radius: 4px; }
        .bubble.user { background: #f1f1f1; color: #333; border-bottom-left-radius: 4px; }
        .bubble.image { background: transparent !important; padding: 0; box-shadow: none; }
        .cb-msg-img { max-width: 200px; border-radius: 12px; border: 1px solid #eee; cursor: zoom-in; }
        .cb-time { font-size: 11px; color: #aaa; margin: 4px 2px 0; }

        #typing-status { height: 24px; padding: 0 15px; font-size: 12px; color: #888; display: flex; align-items: center; background: #fff; }
        
        #reply-box { padding: 10px 15px 15px 15px; border-top: 1px solid #eee; background: #fff; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        #reply-input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 24px; outline: none; font-size: 16px; background: #f9f9f9; -webkit-appearance: none; }
        #reply-input:focus { border-color: #0084ff; background: #fff; }
        #upload-btn { cursor: pointer; font-size: 26px; color: #0084ff; padding: 5px; display: flex; align-items: center; }
        #file-input { display: none; }
        #send-btn { width: 40px; height: 40px; cursor: pointer; margin-left: 2px; border-radius: 50%; transition: transform 0.1s; }
        #send-btn:active { transform: scale(0.9); background: #f0f0f0; }

        #image-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; backdrop-filter: blur(5px); animation: fadeIn 0.2s; }
        #modal-img { max-width: 95%; max-height: 95%; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); animation: zoomIn 0.2s; object-fit: contain; }
        #close-modal { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; font-weight: bold; cursor: pointer; z-index: 2001; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        @keyframes zoomIn { from {transform:scale(0.9);} to {transform:scale(1);} }
        
        .status-box { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; background: #fff; }
        .status-label { font-size: 14px; font-weight: bold; color: #555; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; } 
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûÔºöÂè≥ÂÅ¥ÂÆ¢Êà∂Ë≥áË®äÂç° (Profile Sidebar) ‚òÖ‚òÖ‚òÖ */
        #profile-sidebar {
            width: 0; 
            background: white; 
            border-left: 1px solid #e0e0e0; 
            transition: width 0.3s ease; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
        }
        #profile-sidebar.open { width: 300px; }

        .profile-header { padding: 20px; text-align: center; border-bottom: 1px solid #eee; background: #fafafa; }
        .profile-avatar { width: 80px; height: 80px; background: #0084ff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 10px; font-weight: bold;}
        .profile-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .profile-id { font-size: 12px; color: #999; }

        .profile-body { padding: 20px; flex: 1; overflow-y: auto; }
        .data-row { margin-bottom: 20px; }
        .data-label { font-size: 12px; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase;}
        .data-value { font-size: 15px; color: #333; word-break: break-all; display: flex; align-items: center; gap: 8px;}
        
        .tag { display: inline-block; padding: 2px 8px; background: #e3f2fd; color: #0084ff; border-radius: 12px; font-size: 12px; font-weight: bold; margin-right: 5px; }
        .tag.vip { background: #fff8e1; color: #ff9800; border: 1px solid #ffe082; }

        .stat-box { display: flex; justify-content: space-between; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stat-item { text-align: center; flex: 1; }
        .stat-num { font-size: 18px; font-weight: bold; color: #0084ff; display: block; }
        .stat-desc { font-size: 12px; color: #666; }

        #status-text { font-size: 12px; color: #888; margin-right: 10px; }

        @media (max-width: 768px) {
            /* ÈüøÊáâÂºèÔºöÊâãÊ©üÁâàË¶ÜËìãÊï¥ÂÄãÁï´Èù¢ */
            #profile-sidebar.open { position: absolute; top: 0; right: 0; width: 100%; height: 100%; z-index: 20; }
            #close-profile-btn { display: block; position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; padding: 10px; }

            #dashboard { display: block; }
            #sidebar { width: 100%; position: absolute; top: 0; left: 0; display: flex; }
            #chat-main { width: 100%; position: absolute; top: 0; left: 0; transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 10; }
            #dashboard.show-chat #chat-main { transform: translateX(0); }
            #dashboard.show-chat #sidebar { display: none; } 
            #back-btn { display: block; }
            #chat-header { padding-left: 5px; }
            .cb-msg-img { max-width: 60vw; }
            #footprint-link { max-width: 200px; }
        }
        #close-profile-btn { display: none; }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-card">
            <h2 style="margin-top:0; color:#333;">ÂÆ¢ÊúçÂæåÂè∞ÁôªÂÖ•</h2>
            <input type="text" id="l_shop" placeholder="ÂïÜÂ∫ó ID">
            <input type="password" id="l_pass" placeholder="ÁÆ°ÁêÜÂØÜÁ¢º">
            <button onclick="login()">ÁôªÂÖ•Á≥ªÁµ±</button>
            <p id="l_err" style="color:red; margin-top:10px; font-size:14px;"></p>
        </div>
    </div>

    <div id="image-modal" onclick="closeImageModal()">
        <span id="close-modal">&times;</span>
        <img id="modal-img">
    </div>

    <div id="dashboard">
        <div id="sidebar">
            <div id="shop-info-box">
                <span id="shop-name">ËºâÂÖ•‰∏≠...</span>
                <button id="logout-btn" onclick="logout()">ÁôªÂá∫</button>
            </div>
            
            <div class="status-box">
                <div class="status-label">ÂÆ¢ÊúçÁãÄÊÖã</div>
                <div style="display:flex; align-items:center;">
                    <span id="status-text">Èõ¢Á∑ö</span>
                    <label class="switch">
                        <input type="checkbox" id="online-toggle" onchange="toggleOnline()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div id="user-list"></div>
        </div>

        <div id="chat-main">
            <div id="chat-header">
                <div style="display:flex; align-items:center;">
                    <button id="back-btn" onclick="backToList()">‚ùÆ</button>
                    <span id="chat-title">Ë´ãÈÅ∏Êìá‰ΩøÁî®ËÄÖ</span>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleProfile()" title="Êü•ÁúãÂÆ¢Êà∂Ë≥áÊñô">üë§</button>
                </div>
            </div>

            <div id="footprint-box">
                <span>Ê≠£Âú®ÁÄèË¶ΩÔºö</span>
                <img id="footprint-img">
                <a id="footprint-link" href="#" target="_blank">È¶ñÈ†Å</a>
            </div>

            <div id="messages"></div>
            <div id="typing-status"></div>
            <div id="reply-box">
                <label for="file-input" id="upload-btn">üì∑</label>
                <input type="file" id="file-input" accept="image/*">
                <input type="text" id="reply-input" placeholder="Ëº∏ÂÖ•Ë®äÊÅØ..." disabled>
                <img src="/icon/send.png" id="send-btn" alt="Send">
            </div>
        </div>

        <div id="profile-sidebar">
            <div id="close-profile-btn" onclick="toggleProfile()">‚úï</div>
            
            <div class="profile-header">
                <div class="profile-avatar" id="p-avatar">?</div>
                <div class="profile-name" id="p-name">ËºâÂÖ•‰∏≠</div>
                <div class="profile-id" id="p-id">ID: ...</div>
            </div>

            <div class="profile-body">
                <div class="stat-box">
                    <div class="stat-item">
                        <span class="stat-num" id="p-spent">$0</span>
                        <span class="stat-desc">Á¥ØÁ©çÊ∂àË≤ª</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-num" id="p-orders">0</span>
                        <span class="stat-desc">Ë®ÇÂñÆÊï∏</span>
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-label">Ê®ôÁ±§ (Tags)</div>
                    <div class="data-value" id="p-tags">
                        <span style="color:#999;font-style:italic;">ÁÑ°Ê®ôÁ±§</span>
                    </div>
                </div>

                <div class="data-row">
                    <div class="data-label">ËÅØÁµ°Ë≥áË®ä</div>
                    <div class="data-value">üìß <span id="p-email">--</span></div>
                    <div class="data-value" style="margin-top:5px;">üì± <span id="p-mobile">--</span></div>
                </div>

                <div class="data-row">
                    <div class="data-label">ÁôªÂÖ•ÊñπÂºè</div>
                    <div class="data-value" id="p-login">Ë®™ÂÆ¢</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const SERVER = '/'; 
        let socket;
        let activeUser = null;
        let unreadCounts = {}; 
        let typingTimeout;    
        let userFootprints = {}; 

        // ‚òÖ ÂÑ≤Â≠òÊØèÂÄã‰ΩøÁî®ËÄÖÁöÑË©≥Á¥∞Ë≥áÊñô
        let userProfiles = {}; 

        window.onload = function() {
            const savedShop = localStorage.getItem('admin_shop');
            const savedPass = localStorage.getItem('admin_pass');
            if(savedShop && savedPass) {
                document.getElementById('l_shop').value = savedShop;
                document.getElementById('l_pass').value = savedPass;
                login();
            }
        };

        // --- Ê†∏ÂøÉÈÄ£Á∑öÈÇèËºØ (‰øÆÊ≠£Áâà) ---
        function login() {
            const shop = document.getElementById('l_shop').value.trim();
            const pass = document.getElementById('l_pass').value.trim();
            if(!shop || !pass) { alert("Ë´ãËº∏ÂÖ•Â∏≥ËôüÂØÜÁ¢º"); return; }
            if(socket) socket.disconnect();

            // 1. ÂàùÂßãÂåñ Socket
            socket = io(SERVER, {
                auth: { shopId: shop, isAdmin: true },
                transports: ['websocket', 'polling']
            });

            // 2. Á∂ÅÂÆöÊâÄÊúâ‰∫ã‰ª∂Áõ£ËÅΩÂô® (ÂøÖÈ†àÂú® socket ÂàùÂßãÂåñ‰πãÂæå)
            socket.on('connect', () => {
                socket.emit('adminLogin', { password: pass });
            });

            socket.on('loginSuccess', (data) => {
                localStorage.setItem('admin_shop', shop);
                localStorage.setItem('admin_pass', pass);
                document.getElementById('login-modal').style.display = 'none';
                const dash = document.getElementById('dashboard');
                dash.style.display = (window.innerWidth <= 768) ? 'block' : 'flex';
                document.getElementById('shop-name').innerText = data.shopName;
                
                // Êõ¥Êñ∞ÁãÄÊÖãÈñãÈóú
                const toggle = document.getElementById('online-toggle');
                toggle.checked = data.isOnline;
                updateStatusText(data.isOnline);
            });

            socket.on('loginError', (err) => {
                document.getElementById('l_err').innerText = err;
                localStorage.removeItem('admin_pass');
                socket.disconnect();
            });

            socket.on('initUserList', (users) => {
                const list = document.getElementById('user-list');
                list.innerHTML = '';
                unreadCounts = {}; 
                Object.keys(users).forEach(uid => renderUserInList(uid, users[uid]));
            });

            // ‚òÖ‚òÖ‚òÖ Êé•Êî∂‰ΩøÁî®ËÄÖ Profile Êõ¥Êñ∞ ‚òÖ‚òÖ‚òÖ
            socket.on('userProfileUpdate', (data) => {
                userProfiles[data.userId] = data; // Â≠òËµ∑‰æÜ
                if (activeUser === data.userId) {
                    renderProfile(data.userId); // Â¶ÇÊûúÊ≠£Âú®Áúã‰ªñÔºåÈ¶¨‰∏äÊõ¥Êñ∞‰ªãÈù¢
                }
            });

            // Ë∂≥Ë∑°Êõ¥Êñ∞
            socket.on('userPageUpdate', (data) => {
                userFootprints[data.userId] = data;
                if (activeUser === data.userId) {
                    renderFootprint(data);
                }
            });

            // ÂÆ¢ÊúçÁãÄÊÖãÊõ¥Êñ∞ (ÂêåÊ≠•Áî®)
            socket.on('shopStatusUpdate', (data) => {
                const toggle = document.getElementById('online-toggle');
                toggle.checked = data.isOnline;
                updateStatusText(data.isOnline);
            });

            socket.on('updateUserList', (msg) => {
                const userId = msg.userId;
                let userRow = document.querySelector(`.user-row[data-id="${userId}"]`);
                if (!userRow) {
                    renderUserInList(userId, msg.userName);
                    userRow = document.querySelector(`.user-row[data-id="${userId}"]`);
                } else {
                    const list = document.getElementById('user-list');
                    list.prepend(userRow);
                }
                if (activeUser !== userId && msg.sender !== 'admin') {
                    if (!unreadCounts[userId]) unreadCounts[userId] = 0;
                    unreadCounts[userId]++;
                    const badge = userRow.querySelector('.unread-badge');
                    badge.innerText = unreadCounts[userId] > 99 ? '99+' : unreadCounts[userId];
                    badge.style.display = 'inline-block';
                }
            });

            socket.on('newMessage', (msg) => {
                if (activeUser === msg.userId) {
                    renderMsg(msg);
                    updateTypingStatus(false);
                }
            });

            socket.on('history', (msgs) => {
                const box = document.getElementById('messages');
                box.innerHTML = ''; 
                msgs.forEach(msg => renderMsg(msg));
                updateTypingStatus(false);
            });

            socket.on('displayTyping', (data) => {
                if (activeUser && data.userId === activeUser) {
                    updateTypingStatus(data.isTyping);
                }
            });
        }

        // --- ËºîÂä©ÂáΩÂºè ---

        // ‚òÖ‚òÖ‚òÖ Ê∏≤ÊüìË≥áË®äÂç°ÈÇèËºØ ‚òÖ‚òÖ‚òÖ
        function renderProfile(userId) {
            const data = userProfiles[userId] || {};
            const name = document.getElementById('chat-title').innerText; // ÂæûÊ®ôÈ°åÊäìÂêçÂ≠óÁï∂ÂÇôÊ°à

            document.getElementById('p-avatar').innerText = (data.userName || name || "?")[0].toUpperCase();
            document.getElementById('p-name').innerText = data.userName || name;
            document.getElementById('p-id').innerText = "ID: " + userId;
            
            document.getElementById('p-email').innerText = data.email || "Êú™Êèê‰æõ";
            document.getElementById('p-mobile').innerText = data.mobile || "Êú™Êèê‰æõ";
            
            // ËôïÁêÜÊ®ôÁ±§ (Cyberbiz ÂÇ≥‰æÜÁöÑÊòØÈÄóËôüÂàÜÈöîÂ≠ó‰∏≤)
            const tagsDiv = document.getElementById('p-tags');
            tagsDiv.innerHTML = '';
            if (data.tags) {
                data.tags.split(',').forEach(tag => {
                    const span = document.createElement('span');
                    span.className = 'tag';
                    if(tag.includes('VIP')) span.className += ' vip'; // ÁâπÊÆäÊ®£Âºè
                    span.innerText = tag;
                    tagsDiv.appendChild(span);
                });
            } else {
                tagsDiv.innerHTML = '<span style="color:#999;font-style:italic;">ÁÑ°Ê®ôÁ±§</span>';
            }

            // 3. Ê∂àË≤ªÁµ±Ë®àÂçÄÂ°ä (‰øÆÊîπÈÄôË£°)
            let spent = parseFloat(data.totalSpent || 0).toLocaleString();
            document.getElementById('p-spent').innerText = `$${spent}`;
            document.getElementById('p-orders').innerText = data.ordersCount || '0';
            
            // ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûÔºöÈ¢®Èö™Ë≠¶Á§∫ÂçÄÂ°ä ‚òÖ‚òÖ‚òÖ
            // Â¶ÇÊûúÊúâÊú™ÂèñË≤®Á¥ÄÈåÑ (Â§ßÊñº 0)ÔºåÊèíÂÖ•‰∏ÄÂÄãÈ°ØÁúºÁöÑÁ¥ÖËâ≤Ë≠¶Âëä
            const riskScore = parseInt(data.riskScore || 0);
            
            // Â¶ÇÊûúÊÇ®ÈÇÑÊ≤íÂä† divÔºåÊàëÁõ¥Êé•Áî® JS ÊèíÂú® profile-body ÊúÄ‰∏äÈù¢
            let alertHtml = '';
            if (riskScore > 0) {
                alertHtml = `
                    <div style="background:#ffebee; color:#c62828; padding:10px; border-radius:8px; margin-bottom:15px; font-weight:bold; display:flex; align-items:center; gap:5px;">
                        ‚ö†Ô∏è Ë≠¶ÂëäÔºöÂÅµÊ∏¨Âà∞ ${riskScore} Ê¨°Êú™ÂèñË≤®Á¥ÄÈåÑ
                    </div>
                `;
            }
            
            // ÊääË≠¶ÂëäÊèíÂú® "Ê®ôÁ±§" ‰∏äÈù¢
            const tagsRow = document.querySelector('.profile-body .data-row'); // ÊäìÁ¨¨‰∏ÄÂÄã data-row
            if(riskScore > 0) {
                 // ÈÅøÂÖçÈáçË§áÊèíÂÖ•ÔºåÂÖàÊ™¢Êü•ÊúâÁÑ°ËàäÁöÑ
                 const oldAlert = document.getElementById('js-risk-alert');
                 if(oldAlert) oldAlert.remove();
                 
                 const alertDiv = document.createElement('div');
                 alertDiv.id = 'js-risk-alert';
                 alertDiv.innerHTML = alertHtml;
                 tagsRow.parentNode.insertBefore(alertDiv, tagsRow);
            } else {
                 const oldAlert = document.getElementById('js-risk-alert');
                 if(oldAlert) oldAlert.remove();
            }

            document.getElementById('p-login').innerText = data.loginType || (userId.startsWith('guest') ? 'Ë®™ÂÆ¢' : '‰∏ÄËà¨ÊúÉÂì°');
        }

        function toggleProfile() {
            const sidebar = document.getElementById('profile-sidebar');
            sidebar.classList.toggle('open');
        }

        // ÂàáÊèõ‰ΩøÁî®ËÄÖÊôÇ
        function selectUser(uid, name) {
            activeUser = uid;
            
            document.querySelectorAll('.user-row').forEach(e => e.classList.remove('active'));
            document.querySelector(`.user-row[data-id="${uid}"]`).classList.add('active');
            
            unreadCounts[uid] = 0; 
            const badge = document.querySelector(`.user-row[data-id="${uid}"] .unread-badge`);
            if (badge) badge.style.display = 'none';
            
            document.getElementById('chat-title').innerText = name;
            document.getElementById('reply-input').disabled = false;
            document.getElementById('messages').innerHTML = '<div style="text-align:center;color:#999;margin-top:20px;">ËºâÂÖ•‰∏≠...</div>';
            updateTypingStatus(false); 
            showChat();
            renderFootprint(userFootprints[uid]);
            renderProfile(uid);
            socket.emit('adminJoinUser', { userId: uid });
        }

        function toggleOnline() {
            // Èò≤ÂëÜÔºöÁ¢∫‰øù socket Â≠òÂú®
            if (!socket) return; 
            const toggle = document.getElementById('online-toggle');
            const isOnline = toggle.checked;
            socket.emit('adminToggleStatus', { isOnline: isOnline });
            updateStatusText(isOnline);
        }

        function updateStatusText(isOnline) {
            const text = document.getElementById('status-text');
            text.innerText = isOnline ? "Á∑ö‰∏äÂæÖÂëΩ" : "Êö´ÊôÇÈõ¢Èñã";
            text.style.color = isOnline ? "#2ecc71" : "#aaa";
        }

        function backToList() {
            document.getElementById('dashboard').classList.remove('show-chat');
            document.activeElement.blur(); 
            activeUser = null;
        }

        function showChat() {
            document.getElementById('dashboard').classList.add('show-chat');
        }

        function showImage(src) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-img');
            modal.style.display = "flex";
            modalImg.src = src;
        }

        function closeImageModal() {
            document.getElementById('image-modal').style.display = "none";
        }

        function updateTypingStatus(isTyping) {
            const statusDiv = document.getElementById('typing-status');
            if(isTyping) {
                statusDiv.innerHTML = `<span>Â∞çÊñπÊ≠£Âú®Ëº∏ÂÖ•</span><span class="typing-dots"></span>`;
            } else {
                statusDiv.innerHTML = '';
            }
        }

        function logout() {
            localStorage.removeItem('admin_shop');
            localStorage.removeItem('admin_pass');
            location.reload();
        }

        function renderFootprint(data) {
            const box = document.getElementById('footprint-box');
            const link = document.getElementById('footprint-link');
            const img = document.getElementById('footprint-img');

            if (!data) {
                box.style.display = 'none'; 
                return;
            }

            box.style.display = 'flex';
            link.href = data.url;
            link.innerText = data.title || data.url;
            
            if (data.image) {
                img.src = data.image;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }
        }

        function renderUserInList(uid, name) {
            const div = document.createElement('div');
            div.className = 'user-row';
            div.setAttribute('data-id', uid);
            div.innerHTML = `
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:500; font-size:16px;">${name}</span>
                    <span style="font-size:12px;color:#999; margin-top:4px;">${uid}</span>
                </div>
                <span class="unread-badge">0</span>
            `;
            div.onclick = () => selectUser(uid, name);
            const list = document.getElementById('user-list');
            list.prepend(div); 
        }

        function renderMsg(msg) {
            const box = document.getElementById('messages');
            var date = new Date(msg.timestamp);
            var timeStr = date.getHours().toString().padStart(2, '0') + ":" + date.getMinutes().toString().padStart(2, '0');
            const row = document.createElement('div');
            row.className = `cb-msg-row ${msg.sender}`;
            let contentHtml = '';
            if (msg.msgType === 'image') {
                contentHtml = `<div class="bubble image ${msg.sender}">
                    <img src="${msg.text}" class="cb-msg-img" onclick="showImage(this.src)">
                </div>`;
            } else {
                contentHtml = `<div class="bubble ${msg.sender}">${msg.text}</div>`;
            }
            row.innerHTML = `${contentHtml}<div class="cb-time">${timeStr}</div>`;
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        const input = document.getElementById('reply-input');
        function sendTextMsg() {
            // Èò≤ÂëÜÔºöÁ¢∫‰øù socket Â≠òÂú®‰∏î activeUser Â≠òÂú®
            if (socket && activeUser && input.value.trim() !== '') {
                socket.emit('adminSendMessage', { targetUserId: activeUser, text: input.value, msgType: 'text' });
                socket.emit('adminTyping', { targetUserId: activeUser, isTyping: false });
                input.value = '';
            }
        }
        input.addEventListener('input', () => {
            if(activeUser && socket) {
                socket.emit('adminTyping', { targetUserId: activeUser, isTyping: true });
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    socket.emit('adminTyping', { targetUserId: activeUser, isTyping: false });
                }, 2000);
            }
        });
        input.onkeypress = (e) => { if (e.key === 'Enter') sendTextMsg(); };
        document.getElementById('send-btn').onclick = sendTextMsg;

        const fileInput = document.getElementById('file-input');
        fileInput.onchange = async function() {
            if(!activeUser) { alert("Ë´ãÂÖàÈÅ∏Êìá‰ΩøÁî®ËÄÖ"); fileInput.value = ''; return; }
            if(!socket) { alert("Â∞öÊú™ÈÄ£Á∑ö"); return; }
            const file = fileInput.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('image', file);
            try {
                input.placeholder = "‰∏äÂÇ≥‰∏≠...";
                input.disabled = true;
                const res = await fetch(SERVER + 'upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.url) {
                    socket.emit('adminSendMessage', { targetUserId: activeUser, text: data.url, msgType: 'image' });
                }
            } catch (err) { alert("‰∏äÂÇ≥Â§±Êïó"); } 
            finally { input.placeholder = "Ëº∏ÂÖ•Ë®äÊÅØ..."; input.disabled = false; fileInput.value = ''; }
        };
    </script>
</body>
</html>