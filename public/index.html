<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客戶端測試 - 即時客服</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; }
        #chat-widget { position: fixed; bottom: 20px; right: 20px; width: 350px; height: 500px; 
                       background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
                       display: flex; flex-direction: column; overflow: hidden; }
        #chat-header { background: #0084ff; color: white; padding: 15px; font-weight: bold; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 15px; font-size: 14px; word-break: break-all; }
        .msg.user { align-self: flex-end; background: #0084ff; color: white; }
        .msg.admin { align-self: flex-start; background: #e4e6eb; color: black; }
        #input-area { border-top: 1px solid #ddd; padding: 10px; display: flex; }
        #msgInput { flex: 1; border: 1px solid #ddd; padding: 8px; border-radius: 20px; outline: none; }
    </style>
</head>
<body>

    <h1>這是您的 Cyberbiz 商店模擬頁面</h1>
    <p>右下角是即時客服小窗口。</p>

    <div id="chat-widget">
        <div id="chat-header">即時客服 - 在線中</div>
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="msgInput" placeholder="請輸入訊息...">
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const SERVER_URL = 'http://192.168.1.102:8188';
        const socket = io(SERVER_URL);
        
        // 取得或生成唯一 ID
        let userId = localStorage.getItem('chat_user_id');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('chat_user_id', userId);
        }

        // 加入房間
        socket.emit('join', { userId, isAdmin: false });

        // 接收歷史訊息 (解決刷新頁面問題)
        socket.on('history', (history) => {
            const container = document.getElementById('messages');
            container.innerHTML = ''; // 清空避免重複顯示
            history.forEach(appendMessage);
            scrollToBottom();
        });

        // 接收新訊息 (即時同步)
        socket.on('newMessage', (msg) => {
            appendMessage(msg);
            scrollToBottom();
        });

        function appendMessage(msg) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `msg ${msg.sender === 'admin' ? 'admin' : 'user'}`;
            div.innerText = msg.text;
            container.appendChild(div);
        }

        function scrollToBottom() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        // 發送訊息
        document.getElementById('msgInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.value.trim() !== '') {
                const text = e.target.value;
                socket.emit('sendMessage', {
                    userId,
                    text,
                    sender: 'user',
                    timestamp: Date.now()
                });
                e.target.value = '';
            }
        });
    </script>
</body>
</html>